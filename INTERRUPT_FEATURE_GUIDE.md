# 语音打断功能使用指南

## 功能概述

语音打断功能允许您在AI正在播放回答时，通过说出"打断词"来立即停止AI的播放，并开始新一轮对话。这就像真实对话中打断别人说话一样自然。

## 核心特性

- ✅ **实时监听**：AI播放时同时监听麦克风
- ✅ **即时响应**：检测到打断词后立即停止播放
- ✅ **清空队列**：停止当前播放并清空所有待播放内容
- ✅ **继续对话**：打断后立即返回等待唤醒词状态
- ✅ **可配置**：支持自定义打断词列表

## 使用场景

### 场景1：AI回答太长

```
用户："小爱小爱，详细介绍一下人工智能的发展历史"
AI  ："人工智能的发展可以追溯到1950年代...（开始长篇大论）"
用户："停止！"  ← 打断
AI  ：（立即停止播放，清空队列）
系统：🔍 监听唤醒词...
```

### 场景2：AI理解错误

```
用户："小爱小爱，今天天气怎么样"
AI  ："今天天气很好，适合...（语音识别错误，在说其他内容）"
用户："暂停！"  ← 打断
AI  ：（立即停止）
用户："小爱小爱，重新问：今天天气怎么样"
```

### 场景3：已经听够了

```
用户："小爱小爱，讲个笑话"
AI  ："有一天小明去上学，他遇到了...（开始讲故事）"
用户："好了好了，别说了"  ← 打断
AI  ：（立即停止）
用户："小爱小爱，下一个问题..."
```

## 配置说明

### 打开Web配置界面

访问：http://localhost:8080

进入 **🎙️ 语音对话** 标签页

找到 **🛑 打断词设置** 区域

### 配置项

#### 1. 启用打断词模式

```
☑ 启用打断词模式
```

**说明**：勾选后，AI播放时会同时监听打断词

**建议**：保持启用（默认开启）

#### 2. 打断词列表

```
停止, 暂停, 别说了, 闭嘴, 停下
```

**说明**：
- 用逗号分隔多个打断词
- 系统会检测任意一个
- 支持中文和英文

**建议打断词**：
- **简短易说**："停"、"暂停"、"停止"
- **口语化**："别说了"、"好了"、"够了"
- **果断明确**："闭嘴"、"停下"

### 保存配置

1. 修改打断词列表
2. 点击 **💾 保存配置**
3. 点击 **🔄 重启** 语音对话服务
4. 配置生效

## 工作原理

### 技术流程

```
┌─────────────────────────────────────────┐
│        用户提问："什么是人工智能"        │
└────────────────┬────────────────────────┘
                 ↓
┌─────────────────────────────────────────┐
│        LLM开始流式生成回答              │
│        "人工智能是..."                   │
└────────────────┬────────────────────────┘
                 ↓
       ┌─────────┴─────────┐
       ↓                   ↓
┌──────────────┐    ┌──────────────┐
│ 播放线程      │    │ 监听线程      │
│ 🔊 播放音频   │    │ 👂 监听打断词 │
│              │    │              │
│ 播放句子1     │    │ 每2秒录音     │
│ ↓            │    │ ↓            │
│ 播放句子2     │    │ ASR识别      │
│ ↓            │    │ ↓            │
│ 播放句子3     │    │ 检查打断词    │
└──────┬───────┘    └──────┬───────┘
       │                   │
       │   ← ← ← "停止" ← ←│
       ↓
┌─────────────────────────────────────────┐
│   ⏹️ 检测到打断词！                      │
│   1. 设置 interrupt_flag = True         │
│   2. 播放线程检查标志并停止              │
│   3. 清空播放队列                        │
│   4. 停止监听线程                        │
└────────────────┬────────────────────────┘
                 ↓
┌─────────────────────────────────────────┐
│   🔍 返回监听唤醒词状态                  │
│   等待下一次对话...                      │
└─────────────────────────────────────────┘
```

### 关键代码

#### 打断监听（voice_chat.py:684-722）

```python
def monitor_interrupt(self, input_device=None):
    """监听打断词的后台线程"""
    if not self.INTERRUPT_MODE:
        return

    logger.info("👂 开始监听打断词...")

    while not self.interrupt_flag:
        # 录制2秒音频
        audio_file = self.record_audio_short(input_device, duration=2.0)

        # 识别音频
        text = self.speech_to_text(audio_file)

        # 检查是否包含打断词
        for interrupt_word in self.INTERRUPT_WORDS:
            if interrupt_word in text:
                logger.info(f"🛑 检测到打断词: {interrupt_word}")
                self.interrupt_flag = True
                return
```

#### 播放检查（voice_chat.py:137-151）

```python
# 播放完一句后检查是否被打断
if self.voice_assistant.interrupt_flag:
    logger.info("⏹️ 检测到打断标志，清空播放队列")
    # 清空剩余队列
    while not self.queue.empty():
        remaining_file, _ = self.queue.get_nowait()
        if remaining_file and os.path.exists(remaining_file):
            os.unlink(remaining_file)
        self.queue.task_done()
    # 跳出播放循环
    break
```

#### 流式生成检查（voice_chat.py:625-628）

```python
# 逐块接收LLM输出
for line in response.iter_lines():
    # 检查是否被打断
    if self.interrupt_flag:
        logger.info("⏹️ 检测到打断，停止生成内容")
        break
```

## 配置文件

### config.yaml

```yaml
voice_chat:
  # ... 其他配置 ...

  # 打断词功能
  interrupt_mode: true          # 是否启用打断词
  interrupt_words:              # 打断词列表
    - 停止
    - 暂停
    - 别说了
    - 闭嘴
    - 停下
```

## 使用示例

### 示例1：完整对话流程

```
步骤1：唤醒
用户："小爱小爱"
系统：🗣️ 检测到唤醒词: 小爱
AI  ："你好，我在"

步骤2：提问
用户："介绍一下北京大学"
系统：📝 识别结果: 介绍一下北京大学
      🤖 AI开始回复...
      👂 打断监听线程已启动

步骤3：播放（同时监听）
AI  ："北京大学是中国最顶尖的高等学府之一，成立于1898年..."
系统：🔊 正在播放: 北京大学是中国最顶尖的高等学府之一...
      👂 监听打断词...
      👂 监听到: （无）

步骤4：打断
用户："停止"
系统：👂 监听到: 停止
      🛑 检测到打断词: 停止
      ⏹️ 检测到打断标志，清空播放队列
      ⏹️ 对话已被打断

步骤5：继续对话
系统：🔍 监听唤醒词...
用户："小爱小爱"
系统：🗣️ 检测到唤醒词: 小爱
AI  ："你好，我在"
用户："讲个笑话"
...
```

### 示例2：多次打断

```
对话1：
用户："小爱小爱，详细介绍人工智能"
AI  ："人工智能...（开始长篇）"
用户："暂停"  ← 第1次打断
系统：⏹️ 已打断

对话2：
用户："小爱小爱，简单说一下就好"
AI  ："人工智能是...（简短回答）"
用户：（听完，未打断）
系统：✅ 所有音频播放完成

对话3：
用户："小爱小爱，那机器学习呢"
AI  ："机器学习...（又开始详细讲）"
用户："好了好了，别说了"  ← 第2次打断
系统：⏹️ 已打断
```

## 注意事项

### 1. 监听频率

- 每2秒录音一次进行检测
- 不是实时检测，有轻微延迟（最多2秒）
- 如果需要更快响应，可修改 `duration=2.0` 为更小值

### 2. 打断词选择

**推荐**：
- ✅ 简短：1-2个字/音节
- ✅ 清晰：发音明确不易混淆
- ✅ 果断：表达停止的明确意图

**不推荐**：
- ❌ 太长："麻烦你停止一下好吗"
- ❌ 模糊："嗯"、"啊"
- ❌ 常用词："好"、"是"（可能误触发）

### 3. ASR识别限制

- 打断词需要能被ASR正确识别
- 如果环境噪音大，可能识别不准
- 建议说话清晰、音量适中

### 4. 对话历史

**重要**：打断的对话**不会**保存到历史记录

```python
# 更新对话历史 - 只有未被打断时才添加
if full_reply and not self.interrupt_flag:
    self.conversation_history.append([message, full_reply])
```

这意味着：
- 打断后，AI不记得刚才说了什么
- 打断后，您的问题也不在历史中
- 下次对话是全新的上下文

### 5. 性能影响

**CPU使用**：
- 监听线程每2秒会调用ASR服务一次
- 会略微增加CPU负载
- 对于长时间播放（如讲故事），影响可接受

**延迟**：
- 最快：说完打断词后立即停止
- 最慢：需要等待当前2秒录音周期完成
- 平均：约1秒延迟

## 故障排查

### 问题1：说了打断词但没有停止

**可能原因**：
1. ASR识别错误
2. 打断词不在配置列表中
3. 环境噪音太大

**解决方法**：
```bash
# 查看日志，看是否识别到
tail -f logs/语音对话.log | grep "监听到"

# 应该看到：
# 👂 监听到: 停止
# 🛑 检测到打断词: 停止
```

如果没有识别到，尝试：
- 说话更清晰
- 增大音量
- 换一个打断词
- 减少环境噪音

### 问题2：误触发打断

**症状**：AI正常说话时突然停止

**原因**：环境中的声音被误识别为打断词

**解决方法**：
1. 使用更特殊的打断词（避免日常用语）
2. 提高麦克风灵敏度阈值
3. 暂时关闭打断功能

```yaml
voice_chat:
  interrupt_mode: false  # 临时关闭
```

### 问题3：打断后无法继续对话

**症状**：打断后说唤醒词没有响应

**原因**：可能是服务异常退出

**解决方法**：
```bash
# 查看服务状态
curl http://localhost:5004/status

# 重启服务
# 在Web界面点击 "🔄 重启"
```

## 高级用法

### 自定义打断词

根据您的使用习惯自定义：

**正式场景**：
```yaml
interrupt_words:
  - 停止
  - 暂停
  - 请停一下
```

**随意场景**：
```yaml
interrupt_words:
  - 停
  - 行了
  - 够了
  - 别说了
```

**多语言**：
```yaml
interrupt_words:
  - 停止          # 中文
  - stop          # 英文
  - 暂停
  - pause
```

### 调整监听频率

修改 `voice_chat.py:697` 的录音时长：

```python
# 原来：每2秒检测一次
audio_file = self.record_audio_short(input_device, duration=2.0)

# 改为：每1秒检测一次（更快响应）
audio_file = self.record_audio_short(input_device, duration=1.0)

# 改为：每3秒检测一次（降低CPU负载）
audio_file = self.record_audio_short(input_device, duration=3.0)
```

**权衡**：
- 时长越短 → 响应越快，但CPU负载越高
- 时长越长 → CPU负载越低，但响应越慢

## 相关文档

- [AUTO_START_GUIDE.md](AUTO_START_GUIDE.md) - 自动启动功能
- [TTS_ASYNC_OPTIMIZATION.md](TTS_ASYNC_OPTIMIZATION.md) - TTS异步优化
- [CONVERSATION_HISTORY_FIX.md](CONVERSATION_HISTORY_FIX.md) - 对话历史修复
- [VOLUME_MONITOR_GUIDE.md](VOLUME_MONITOR_GUIDE.md) - 音量监测工具

---

**文档版本**: v1.0
**最后更新**: 2025-10-25
**适用版本**: AI语音助手 v1.3+
**功能状态**: ✅ 已实现并可用
