# 麦克风音量监测工具使用指南

## 功能概述

麦克风音量监测工具是一个帮助用户找到最佳VAD（Voice Activity Detection）静音阈值的实用功能。它能够：

- ✅ 实时监测麦克风环境噪音
- ✅ 计算并显示RMS（均方根）音量统计数据
- ✅ 自动推荐最佳静音阈值
- ✅ 解决录音超时无法结束的问题

## 使用场景

### 何时需要使用此工具？

1. **首次配置语音助手**：不确定应该设置多少静音阈值
2. **录音一直超时**：说完话后录音不会自动结束，总是等到30秒超时
3. **更换环境**：从安静环境移动到嘈杂环境（或反之）
4. **更换麦克风**：使用新的USB麦克风或其他录音设备
5. **环境噪音变化**：房间内增加了风扇、空调等噪音源

## 快速开始

### 步骤1：打开Web配置界面

访问：http://localhost:8080

进入 **🎙️ 语音对话** 标签页

### 步骤2：找到音量监测工具

向下滚动找到 **🎤 麦克风音量监测工具** 区域（在"VAD参数设置"之前）

### 步骤3：开始监测

1. **确保环境安静**：不要说话，保持环境安静
2. 点击 **🎤 开始监测（10秒）** 按钮
3. 等待10秒，期间界面会实时显示监测数据
4. 监测完成后查看推荐阈值

### 步骤4：应用推荐阈值

将 **🎯 推荐静音阈值** 中显示的数值填入下方的 **静音阈值** 滑块

点击 **💾 保存配置** 按钮

## 界面说明

### 监测控制按钮

| 按钮 | 功能 |
|------|------|
| **🎤 开始监测（10秒）** | 启动音量监测，持续10秒 |
| **⏹️ 停止监测** | 提前停止监测 |

### 监测数据显示

| 字段 | 说明 | 示例值 |
|------|------|--------|
| **监测状态** | 当前监测进度 | "⏳ 监测中... (已采集 120 个样本)" |
| **当前RMS** | 实时麦克风音量 | 523 |
| **平均RMS** | 10秒内环境噪音平均值 | 487 |
| **最小RMS** | 监测期间的最小噪音值 | 312 |
| **最大RMS** | 监测期间的最大噪音值 | 678 |
| **🎯 推荐静音阈值** | 自动计算的推荐值 | 633 |

## 推荐阈值计算原理

### 计算公式

```
推荐阈值 = 平均环境噪音RMS × 1.3
```

### 为什么是1.3倍？

- **安全边际**：确保阈值高于环境噪音波动
- **可靠检测**：停止说话后能够稳定检测到"静音"
- **避免误触发**：偶尔的噪音尖峰不会被误认为是说话

### 示例计算

```
环境噪音数据：
  - 平均RMS: 500
  - 最小RMS: 320
  - 最大RMS: 680

计算过程：
  推荐阈值 = 500 × 1.3 = 650

验证：
  ✅ 650 > 680（高于最大噪音）
  ✅ 650 < 2000（远低于说话音量）
  ✅ 合适！
```

## 实际使用示例

### 示例1：安静办公室环境

**监测结果**：
```
当前RMS: 285
平均RMS: 300
最小RMS: 245
最大RMS: 398
推荐阈值: 390
```

**操作**：
1. 将"静音阈值"设置为 **400**（略高于推荐值）
2. 保存配置
3. 测试语音对话，应该能在1-2秒内自动结束录音

**预期效果**：
- 说话时RMS：1500-3000（远高于阈值400）
- 安静时RMS：~300（低于阈值400）
- ✅ 系统能清晰区分说话和安静

### 示例2：嘈杂环境（风扇运转）

**监测结果**：
```
当前RMS: 1150
平均RMS: 1100
最小RMS: 950
最大RMS: 1280
推荐阈值: 1430
```

**操作**：
1. 将"静音阈值"设置为 **1500**
2. 保存配置
3. 可能需要说话声音稍大一些

**预期效果**：
- 说话时RMS：2500-4000（高于阈值1500）
- 噪音RMS：~1100（低于阈值1500）
- ✅ 仍能正常工作，但需要更大声说话

### 示例3：极安静环境（录音室）

**监测结果**：
```
当前RMS: 85
平均RMS: 90
最小RMS: 65
最大RMS: 128
推荐阈值: 117
```

**操作**：
1. 将"静音阈值"设置为 **150**
2. 保存配置
3. 可以非常轻声说话

**预期效果**：
- 说话时RMS：500-1500（即使轻声也远高于阈值）
- 噪音RMS：~90（远低于阈值150）
- ✅ 非常灵敏，轻声细语也能检测

## 技术实现

### 后端API ([voice_chat.py](voice_chat.py))

#### 1. 启动监测

```bash
POST /volume/start
```

**请求参数**：
```json
{
  "input_device": 1,    // 可选，麦克风设备索引
  "duration": 10        // 可选，监测持续时间（秒）
}
```

**响应**：
```json
{
  "success": true,
  "message": "音量监测已启动，持续 10 秒",
  "duration": 10
}
```

#### 2. 获取监测数据

```bash
GET /volume/data
```

**响应**：
```json
{
  "success": true,
  "running": true,
  "data": {
    "current_rms": 523,
    "min_rms": 312,
    "max_rms": 678,
    "avg_rms": 487,
    "sample_count": 120,
    "recommended_threshold": 633
  }
}
```

#### 3. 停止监测

```bash
POST /volume/stop
```

**响应**：
```json
{
  "success": true,
  "message": "音量监测已停止"
}
```

### 核心算法

#### RMS计算 ([voice_chat.py:1127-1132](voice_chat.py#L1127-L1132))

```python
audio_array = np.frombuffer(audio_data, dtype=np.int16)
rms = np.sqrt(np.mean(audio_array.astype(np.float64) ** 2))
```

#### 阈值推荐 ([voice_chat.py:1055-1076](voice_chat.py#L1055-L1076))

```python
def calculate_recommended_threshold(samples, percentile=80):
    """
    基于样本数据计算推荐的静音阈值

    Args:
        samples: RMS样本列表
        percentile: 百分位数（默认80%）

    Returns:
        推荐的阈值
    """
    sorted_samples = sorted(samples)
    index = int(len(sorted_samples) * percentile / 100)
    base_threshold = sorted_samples[index]

    # 添加30%的安全边际
    recommended = int(base_threshold * 1.3)

    return recommended
```

**算法说明**：
1. 对所有RMS样本排序
2. 取80百分位数（高于80%的噪音值）
3. 乘以1.3作为安全边际
4. 确保推荐值能够可靠区分噪音和说话

### Web界面实现 ([web_ui.py](web_ui.py))

#### UI组件

- **监测按钮**：触发监测启动
- **停止按钮**：提前停止监测
- **实时显示**：每500ms刷新一次数据
- **状态提示**：显示监测进度和完成提示

#### 自动刷新机制

```python
# Gradio定时器，每500ms刷新
volume_timer = gr.Timer(value=0.5, active=False)
volume_timer.tick(
    get_volume_data,  # 调用API获取最新数据
    outputs=[...]      # 更新所有显示字段
)
```

## 故障排查

### 问题1：点击"开始监测"无反应

**可能原因**：
- 语音对话服务未启动
- 麦克风设备未配置或不可用

**解决方法**：
```bash
# 1. 检查服务状态
curl http://localhost:5004/status

# 2. 检查音频设备
python -c "
import pyaudio
p = pyaudio.PyAudio()
for i in range(p.get_device_count()):
    info = p.get_device_info_by_index(i)
    if info['maxInputChannels'] > 0:
        print(f'{i}: {info[\"name\"]}')
"

# 3. 重启语音对话服务
# 在Web界面点击 "🔄 重启"
```

### 问题2：监测数据全是0

**可能原因**：
- 麦克风被其他程序占用
- 麦克风静音或音量为0
- 权限问题

**解决方法**：
```bash
# 1. 检查麦克风是否被占用
lsof /dev/snd/*

# 2. 检查麦克风音量
pactl list sources | grep -E "(Name|Volume|Mute)"

# 3. 调整麦克风音量
pactl set-source-volume @DEFAULT_SOURCE@ 80%
pactl set-source-mute @DEFAULT_SOURCE@ 0
```

### 问题3：推荐阈值太高或太低

**情况A：推荐阈值太高（如5000）**

**原因**：环境噪音过大或麦克风增益过高

**解决**：
1. 降低麦克风输入增益
2. 减少环境噪音源（关闭风扇、空调等）
3. 更换麦克风位置，远离噪音源

**情况B：推荐阈值太低（如100）**

**原因**：环境过于安静或麦克风增益过低

**解决**：
1. 提高麦克风输入增益
2. 验证麦克风是否正常工作
3. 检查是否选择了正确的输入设备

### 问题4：使用推荐阈值后仍然超时

**可能原因**：
- 说话音量太小
- 麦克风灵敏度问题
- 存在持续性噪音

**调试方法**：
```bash
# 查看实际录音时的RMS值
tail -f logs/语音对话.log | grep "RMS"

# 应该看到类似输出：
# 说话时: RMS: 2500 > 阈值: 800  ✅ 正常
# 停止时: RMS: 600  < 阈值: 800  ✅ 能检测到静音
```

**解决方法**：
1. 如果说话时RMS也低于阈值：
   - 说话声音大一些
   - 或降低阈值到说话RMS的50-70%

2. 如果停止后RMS仍高于阈值：
   - 提高阈值
   - 或减少环境噪音

## 最佳实践

### 1. 定期重新监测

建议在以下情况重新监测：
- ✅ 每次更换环境
- ✅ 每次更换麦克风
- ✅ 环境噪音明显变化时
- ✅ 每周定期校准一次

### 2. 不同场景使用不同配置

**场景A：家庭安静环境**
```yaml
voice_chat:
  silence_threshold: 500-800
  silence_duration: 1.0
  input_device: 1  # USB麦克风
```

**场景B：办公室环境**
```yaml
voice_chat:
  silence_threshold: 1000-1500
  silence_duration: 1.5
  input_device: 1
```

**场景C：嘈杂公共场所**
```yaml
voice_chat:
  silence_threshold: 2000-3000
  silence_duration: 2.0
  input_device: 1
```

### 3. 监测前准备

- ✅ 关闭正在播放的音乐/视频
- ✅ 暂停语音对话功能（避免冲突）
- ✅ 确保麦克风未被占用
- ✅ 保持安静10秒（不要说话）

### 4. 验证配置

设置推荐阈值后，进行测试：
1. 启动语音对话
2. 唤醒："小爱小爱"
3. 说一句话："今天天气怎么样"
4. 停止说话，观察是否在1-2秒内自动结束录音
5. ✅ 如果正常结束 → 配置成功
6. ❌ 如果仍然超时 → 查看日志调整

## 相关配置参数

### config.yaml 配置示例

```yaml
voice_chat:
  enable: true
  input_device: 1                    # 使用监测时的设备
  output_device: null
  output_volume: 50
  silence_threshold: 633             # 使用推荐阈值
  silence_duration: 1.0
  min_audio_length: 0.5
  wake_mode: true
  wake_words:
    - 小助手
    - 小爱
```

### 参数说明

| 参数 | 说明 | 推荐值 | 备注 |
|------|------|--------|------|
| `silence_threshold` | 静音阈值 | **使用监测工具推荐值** | 最重要的参数 |
| `silence_duration` | 静音持续时间 | 1.0-2.0秒 | 安静环境可短一些 |
| `min_audio_length` | 最短录音长度 | 0.5秒 | 过滤偶然噪音 |
| `input_device` | 输入设备索引 | 1或2 | 使用监测时的设备 |

## 工作流程图

```
┌─────────────────────────────────────────────────────┐
│         用户操作：点击"开始监测"                      │
└─────────────────┬───────────────────────────────────┘
                  ↓
┌─────────────────────────────────────────────────────┐
│    Web界面调用 POST /volume/start                   │
└─────────────────┬───────────────────────────────────┘
                  ↓
┌─────────────────────────────────────────────────────┐
│    后端启动监测线程，持续10秒                        │
│    - 打开麦克风音频流                                │
│    - 每50ms读取一次音频数据                          │
│    - 计算RMS值并存入样本数组                         │
└─────────────────┬───────────────────────────────────┘
                  ↓
┌─────────────────────────────────────────────────────┐
│    Web界面定时器每500ms刷新                          │
│    调用 GET /volume/data 获取实时数据                │
│    - 当前RMS: 实时更新                               │
│    - 平均RMS: 逐步收敛                               │
│    - 推荐阈值: 动态计算                              │
└─────────────────┬───────────────────────────────────┘
                  ↓
┌─────────────────────────────────────────────────────┐
│    10秒后监测完成                                    │
│    - 计算最终统计数据                                │
│    - 显示推荐阈值                                    │
│    - 提示用户应用设置                                │
└─────────────────┬───────────────────────────────────┘
                  ↓
┌─────────────────────────────────────────────────────┐
│    用户将推荐阈值填入"静音阈值"设置                  │
│    点击"保存配置" → 更新 config.yaml                 │
└─────────────────┬───────────────────────────────────┘
                  ↓
┌─────────────────────────────────────────────────────┐
│    重启语音对话服务使配置生效                        │
│    测试语音对话功能                                  │
│    ✅ 录音能在1-2秒内自动结束！                       │
└─────────────────────────────────────────────────────┘
```

## API参考

### 完整API列表

| 端点 | 方法 | 功能 |
|------|------|------|
| `/volume/start` | POST | 启动音量监测 |
| `/volume/stop` | POST | 停止音量监测 |
| `/volume/data` | GET | 获取监测数据 |
| `/devices` | GET | 获取音频设备列表 |
| `/start` | POST | 启动语音对话 |
| `/stop` | POST | 停止语音对话 |
| `/status` | GET | 获取运行状态 |

### 使用curl测试

```bash
# 1. 启动监测
curl -X POST http://localhost:5004/volume/start \
  -H "Content-Type: application/json" \
  -d '{"duration": 10}'

# 2. 获取实时数据
curl http://localhost:5004/volume/data

# 3. 停止监测
curl -X POST http://localhost:5004/volume/stop
```

## 相关文档

- [VAD_TROUBLESHOOTING.md](VAD_TROUBLESHOOTING.md) - VAD问题详细排查
- [IMPLEMENTATION_SUMMARY.md](IMPLEMENTATION_SUMMARY.md) - 系统实现总结
- [AUTO_START_GUIDE.md](AUTO_START_GUIDE.md) - 自动启动功能说明
- [BLUETOOTH_SETUP_GUIDE.md](BLUETOOTH_SETUP_GUIDE.md) - 蓝牙音箱配置

---

**文档版本**: v1.0
**最后更新**: 2025-10-25
**适用版本**: AI语音助手 v1.2+
**功能状态**: ✅ 已实现并可用
