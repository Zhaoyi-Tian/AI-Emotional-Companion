<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YOLOå®æ—¶æ£€æµ‹</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f0f0f0;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: #333;
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .content {
            display: flex;
            gap: 20px;
        }

        .video-container {
            flex: 2;
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .sidebar {
            flex: 1;
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        #videoCanvas {
            width: 100%;
            max-width: 640px;
            height: auto;
            border: 2px solid #ddd;
            border-radius: 4px;
        }

        .controls {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        button {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
        }

        .detection-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .detection-item {
            padding: 8px;
            margin: 5px 0;
            background: #f0f0f0;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .settings {
            margin-top: 20px;
        }

        .slider-container {
            margin: 10px 0;
        }

        .slider {
            width: 100%;
            margin: 10px 0;
        }

        .stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 20px;
        }

        .stat-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
        }

        .stat-label {
            color: #6c757d;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¥ YOLOå®æ—¶ç›®æ ‡æ£€æµ‹</h1>
            <p>åŸºäºYOLOv5çš„å®æ—¶ç›®æ ‡æ£€æµ‹ç³»ç»Ÿ</p>
        </div>

        <div class="content">
            <!-- è§†é¢‘æ˜¾ç¤ºåŒºåŸŸ -->
            <div class="video-container">
                <h2>å®æ—¶ç”»é¢</h2>
                <canvas id="videoCanvas" width="640" height="480"></canvas>

                <div class="controls">
                    <button id="startBtn" class="btn-primary">å¼€å§‹æ£€æµ‹</button>
                    <button id="stopBtn" class="btn-danger">åœæ­¢æ£€æµ‹</button>
                    <button id="screenshotBtn" class="btn-secondary">æˆªå›¾ä¿å­˜</button>
                    <button id="fullscreenBtn" class="btn-secondary">å…¨å±æ˜¾ç¤º</button>
                </div>

                <div class="status">
                    <strong>è¿æ¥çŠ¶æ€:</strong> <span id="connectionStatus">æœªè¿æ¥</span>
                </div>
            </div>

            <!-- ä¾§è¾¹æ  -->
            <div class="sidebar">
                <h3>æ£€æµ‹å‚æ•°</h3>

                <div class="settings">
                    <div class="slider-container">
                        <label>ç½®ä¿¡åº¦é˜ˆå€¼: <span id="confidenceValue">0.5</span></label>
                        <input type="range" id="confidenceSlider" class="slider"
                               min="0.1" max="1.0" step="0.05" value="0.5">
                    </div>

                    <div class="slider-container">
                        <label>NMSé˜ˆå€¼: <span id="nmsValue">0.4</span></label>
                        <input type="range" id="nmsSlider" class="slider"
                               min="0.1" max="1.0" step="0.05" value="0.4">
                    </div>
                </div>

                <!-- ç»Ÿè®¡ä¿¡æ¯ -->
                <div class="stats">
                    <div class="stat-card">
                        <div class="stat-value" id="fpsValue">0</div>
                        <div class="stat-label">FPS</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="detectionCount">0</div>
                        <div class="stat-label">æ£€æµ‹å¯¹è±¡æ•°</div>
                    </div>
                </div>

                <!-- æ£€æµ‹ç»“æœåˆ—è¡¨ -->
                <h3>æ£€æµ‹ç»“æœ</h3>
                <div id="detectionList" class="detection-list">
                    <p>ç­‰å¾…æ£€æµ‹å¼€å§‹...</p>
                </div>

                <!-- æ—¥å¿— -->
                <h3>ç³»ç»Ÿæ—¥å¿—</h3>
                <div id="logArea" style="height: 150px; overflow-y: auto;
                                        background: #f8f9fa; padding: 10px;
                                        border-radius: 4px; font-size: 12px;">
                    <p>ç³»ç»Ÿå°±ç»ª</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // WebSocketè¿æ¥ç®¡ç†
        let ws = null;
        let canvas = document.getElementById('videoCanvas');
        let ctx = canvas.getContext('2d');
        let isConnected = false;
        let detectionHistory = [];

        // DOMå…ƒç´ 
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const screenshotBtn = document.getElementById('screenshotBtn');
        const fullscreenBtn = document.getElementById('fullscreenBtn');
        const connectionStatus = document.getElementById('connectionStatus');
        const confidenceSlider = document.getElementById('confidenceSlider');
        const confidenceValue = document.getElementById('confidenceValue');
        const nmsSlider = document.getElementById('nmsSlider');
        const nmsValue = document.getElementById('nmsValue');
        const fpsValue = document.getElementById('fpsValue');
        const detectionCount = document.getElementById('detectionCount');
        const detectionList = document.getElementById('detectionList');
        const logArea = document.getElementById('logArea');

        // æ—¥å¿—å‡½æ•°
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            logArea.innerHTML += `<p>[${timestamp}] ${message}</p>`;
            logArea.scrollTop = logArea.scrollHeight;
        }

        // æ›´æ–°æ£€æµ‹åˆ—è¡¨
        function updateDetectionList(detections) {
            if (detections.length === 0) {
                detectionList.innerHTML = '<p>æœªæ£€æµ‹åˆ°å¯¹è±¡</p>';
                return;
            }

            let html = '';
            detections.forEach((det, index) => {
                const confidence = (det.confidence * 100).toFixed(1);
                const bbox = det.bbox || [];
                const position = `(${bbox[0]}, ${bbox[1]})`;

                html += `
                    <div class="detection-item">
                        <span>${index + 1}. ${det.label}</span>
                        <span>${confidence}% ${position}</span>
                    </div>
                `;
            });

            detectionList.innerHTML = html;
            detectionCount.textContent = detections.length;
        }

        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStats(data) {
            if (data.fps) {
                fpsValue.textContent = data.fps.toFixed(1);
            }
            if (data.detections) {
                updateDetectionList(data.detections);
            }
        }

        // è¿æ¥WebSocket
        function connect() {
            // è·å–å½“å‰hostå’Œç«¯å£
            const host = window.location.hostname || 'localhost';
            const port = window.location.port || 8080;
            const wsUrl = `ws://${host}:5005/ws/detect/stream`;

            log(`æ­£åœ¨è¿æ¥åˆ° ${wsUrl}...`);

            ws = new WebSocket(wsUrl);

            ws.onopen = function() {
                isConnected = true;
                connectionStatus.textContent = 'å·²è¿æ¥';
                connectionStatus.style.color = 'green';
                startBtn.disabled = true;
                stopBtn.disabled = false;
                log('WebSocketè¿æ¥æˆåŠŸ');
            };

            ws.onmessage = function(event) {
                try {
                    // å°è¯•è§£ææ–‡æœ¬æ¶ˆæ¯
                    const data = JSON.parse(event.data);
                    if (data.type === 'detections') {
                        updateStats(data.data);
                    } else if (data.type === 'status') {
                        log(`çŠ¶æ€æ›´æ–°: ${JSON.stringify(data.data)}`);
                    }
                } catch (e) {
                    // å¤„ç†äºŒè¿›åˆ¶å›¾åƒæ•°æ®
                    if (event.data instanceof Blob) {
                        const reader = new FileReader();
                        reader.onload = function() {
                            const img = new Image();
                            img.onload = function() {
                                // è°ƒæ•´canvaså¤§å°
                                if (img.width !== canvas.width || img.height !== canvas.height) {
                                    canvas.width = img.width;
                                    canvas.height = img.height;
                                }
                                // ç»˜åˆ¶å›¾åƒ
                                ctx.drawImage(img, 0, 0);
                            };
                            img.src = reader.result;
                        };
                        reader.readAsDataURL(event.data);
                    }
                }
            };

            ws.onclose = function() {
                isConnected = false;
                connectionStatus.textContent = 'å·²æ–­å¼€';
                connectionStatus.style.color = 'red';
                startBtn.disabled = false;
                stopBtn.disabled = true;
                log('WebSocketè¿æ¥å·²æ–­å¼€');
            };

            ws.onerror = function(error) {
                log(`WebSocketé”™è¯¯: ${error}`);
            };
        }

        // æ–­å¼€è¿æ¥
        function disconnect() {
            if (ws) {
                ws.close();
                ws = null;
            }
        }

        // å¼€å§‹æ£€æµ‹
        startBtn.onclick = async function() {
            // å…ˆå¯åŠ¨æ£€æµ‹æœåŠ¡
            try {
                const response = await fetch('/api/start_detection', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        confidence_threshold: parseFloat(confidenceSlider.value),
                        nms_threshold: parseFloat(nmsSlider.value)
                    })
                });

                if (response.ok) {
                    log('æ£€æµ‹æœåŠ¡å·²å¯åŠ¨');
                    // è¿æ¥WebSocket
                    connect();
                } else {
                    log('å¯åŠ¨æ£€æµ‹æœåŠ¡å¤±è´¥');
                }
            } catch (error) {
                log(`é”™è¯¯: ${error.message}`);
            }
        };

        // åœæ­¢æ£€æµ‹
        stopBtn.onclick = function() {
            disconnect();
            log('æ£€æµ‹å·²åœæ­¢');

            // æ¸…ç©ºç”»å¸ƒ
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#f0f0f0';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#666';
            ctx.font = '20px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('æ£€æµ‹å·²åœæ­¢', canvas.width/2, canvas.height/2);
        };

        // æˆªå›¾ä¿å­˜
        screenshotBtn.onclick = function() {
            const link = document.createElement('a');
            link.download = `yolo_detection_${Date.now()}.png`;
            link.href = canvas.toDataURL();
            link.click();
            log('æˆªå›¾å·²ä¿å­˜');
        };

        // å…¨å±æ˜¾ç¤º
        fullscreenBtn.onclick = function() {
            if (canvas.requestFullscreen) {
                canvas.requestFullscreen();
            } else if (canvas.webkitRequestFullscreen) {
                canvas.webkitRequestFullscreen();
            }
        };

        // æ»‘å—äº‹ä»¶
        confidenceSlider.oninput = function() {
            confidenceValue.textContent = this.value;
            updateSettings();
        };

        nmsSlider.oninput = function() {
            nmsValue.textContent = this.value;
            updateSettings();
        };

        // æ›´æ–°è®¾ç½®
        async function updateSettings() {
            try {
                const response = await fetch('/api/update_settings', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        confidence_threshold: parseFloat(confidenceSlider.value),
                        nms_threshold: parseFloat(nmsSlider.value)
                    })
                });
                if (response.ok) {
                    log('è®¾ç½®å·²æ›´æ–°');
                }
            } catch (error) {
                log(`æ›´æ–°è®¾ç½®å¤±è´¥: ${error.message}`);
            }
        }

        // åˆå§‹åŒ–ç”»å¸ƒ
        ctx.fillStyle = '#f0f0f0';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = '#666';
        ctx.font = '20px Arial';
        ctx.textAlign = 'center';
        ctx.fillText('ç‚¹å‡»"å¼€å§‹æ£€æµ‹"å¼€å§‹å®æ—¶ç›®æ ‡æ£€æµ‹', canvas.width/2, canvas.height/2);

        // é¡µé¢åŠ è½½å®Œæˆæ—¥å¿—
        log('é¡µé¢åŠ è½½å®Œæˆï¼Œå‡†å¤‡å°±ç»ª');
    </script>
</body>
</html>