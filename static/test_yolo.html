<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YOLOæ£€æµ‹æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f0f0f0;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .header {
            background: #333;
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .content {
            display: flex;
            gap: 20px;
        }
        .video-section {
            flex: 2;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .info-section {
            flex: 1;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        #videoFrame {
            width: 100%;
            max-width: 640px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .btn-primary {
            background: #007bff;
            color: white;
        }
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            background: #f8f9fa;
        }
        .detection-item {
            padding: 5px 0;
            border-bottom: 1px solid #eee;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¯ YOLOå®æ—¶æ£€æµ‹æµ‹è¯•é¡µé¢</h1>
            <p>ç®€å•ç›´æ¥çš„YOLOæ£€æµ‹æ¼”ç¤º</p>
        </div>

        <div class="content">
            <div class="video-section">
                <h2>å®æ—¶ç”»é¢</h2>
                <img id="videoFrame" src="" alt="YOLOæ£€æµ‹ç”»é¢" />
                <br>
                <button onclick="startDetection()" class="btn-primary">å¼€å§‹æ£€æµ‹</button>
                <button onclick="stopDetection()" class="btn-danger">åœæ­¢æ£€æµ‹</button>
                <button onclick="refreshFrame()" class="btn-primary">åˆ·æ–°ç”»é¢</button>

                <div id="status" class="status">
                    çŠ¶æ€: æœªå¼€å§‹
                </div>
            </div>

            <div class="info-section">
                <h2>æ£€æµ‹ä¿¡æ¯</h2>
                <div>
                    <strong>FPS:</strong> <span id="fps">0.0</span>
                </div>
                <div>
                    <strong>æ£€æµ‹å¯¹è±¡æ•°:</strong> <span id="detectionCount">0</span>
                </div>

                <h3>æ£€æµ‹å¯¹è±¡åˆ—è¡¨</h3>
                <div id="detectionList">
                    <p>ç­‰å¾…å¼€å§‹æ£€æµ‹...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let updateInterval = null;

        async function startDetection() {
            try {
                const response = await fetch('http://localhost:5005/detect/start', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        confidence_threshold: 0.5
                    })
                });

                if (response.ok) {
                    document.getElementById('status').textContent = 'âœ… æ£€æµ‹å·²å¯åŠ¨';
                    // å¼€å§‹å®šæœŸåˆ·æ–°
                    updateInterval = setInterval(refreshFrame, 200); // 200msåˆ·æ–°ä¸€æ¬¡
                } else {
                    document.getElementById('status').textContent = 'âŒ å¯åŠ¨å¤±è´¥';
                }
            } catch (error) {
                document.getElementById('status').textContent = 'âŒ é”™è¯¯: ' + error.message;
            }
        }

        async function stopDetection() {
            try {
                const response = await fetch('http://localhost:5005/detect/stop', {
                    method: 'POST'
                });

                if (response.ok) {
                    document.getElementById('status').textContent = 'â¹ï¸ æ£€æµ‹å·²åœæ­¢';
                    if (updateInterval) {
                        clearInterval(updateInterval);
                        updateInterval = null;
                    }
                }
            } catch (error) {
                document.getElementById('status').textContent = 'âŒ é”™è¯¯: ' + error.message;
            }
        }

        async function refreshFrame() {
            try {
                const response = await fetch('http://localhost:5005/detect/latest');

                if (response.ok) {
                    const data = await response.json();

                    if (data.success && data.frame_base64) {
                        // æ›´æ–°å›¾åƒ
                        document.getElementById('videoFrame').src = 'data:image/jpeg;base64,' + data.frame_base64;

                        // æ›´æ–°æ£€æµ‹ä¿¡æ¯
                        const detections = data.detections;
                        document.getElementById('fps').textContent = detections.fps.toFixed(1);
                        document.getElementById('detectionCount').textContent = detections.detections.length;

                        // æ›´æ–°æ£€æµ‹åˆ—è¡¨
                        const listHtml = detections.detections.map((det, index) => {
                            return `<div class="detection-item">
                                ${index + 1}. ${det.label}: ${(det.confidence * 100).toFixed(1)}%
                                <br><small>ä½ç½®: [${det.bbox.join(', ')}]</small>
                            </div>`;
                        }).join('');

                        document.getElementById('detectionList').innerHTML = listHtml || '<p>æœªæ£€æµ‹åˆ°å¯¹è±¡</p>';
                    }
                }
            } catch (error) {
                console.error('åˆ·æ–°å¸§å‡ºé”™:', error);
            }
        }

        // é¡µé¢åŠ è½½åè‡ªåŠ¨å°è¯•è·å–ä¸€å¸§
        window.onload = function() {
            refreshFrame();
        };
    </script>
</body>
</html>