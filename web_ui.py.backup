"""
Webé…ç½®ç®¡ç†ç•Œé¢
ä½¿ç”¨Gradioæä¾›å‹å¥½çš„é…ç½®ç®¡ç†ã€æµ‹è¯•ç•Œé¢å’ŒAIå¯¹è¯åŠŸèƒ½
"""

import gradio as gr
import requests
import soundfile as sf
import numpy as np
from pathlib import Path
import sys
import logging
import tempfile
import subprocess
import os

# æ·»åŠ çˆ¶ç›®å½•åˆ°è·¯å¾„
sys.path.insert(0, str(Path(__file__).parent))
from config_loader import config, get_config, set_config, reload_config

# é…ç½®æ—¥å¿—
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger("WebUI")


# ==================== AIå¯¹è¯åŠ©æ‰‹ç±» ====================
class AIAssistant:
    """AIåŠ©æ‰‹æ ¸å¿ƒç±»ï¼Œæ•´åˆASRã€LLMã€TTSæœåŠ¡"""

    def __init__(self):
        self.conversation_history = []

    def speech_to_text(self, audio_file):
        """è¯­éŸ³è½¬æ–‡å­—ï¼ˆASRæœåŠ¡ï¼‰"""
        try:
            port = get_config('services.asr', 5001)
            url = f"http://localhost:{port}/transcribe"

            with open(audio_file, 'rb') as f:
                files = {'audio': f}
                response = requests.post(url, files=files, timeout=30)

            if response.status_code == 200:
                result = response.json()
                return result.get('text', '')
            else:
                logger.error(f"ASRè¯†åˆ«å¤±è´¥: {response.text}")
                return None

        except Exception as e:
            logger.error(f"ASRæœåŠ¡è°ƒç”¨å¤±è´¥: {e}")
            return None

    def text_to_speech(self, text):
        """æ–‡å­—è½¬è¯­éŸ³ï¼ˆTTSæœåŠ¡ï¼‰"""
        try:
            port = get_config('services.tts', 5003)
            url = f"http://localhost:{port}/synthesize"

            payload = {"text": text}
            # æ ¹æ®æ–‡æœ¬é•¿åº¦åŠ¨æ€è®¾ç½®è¶…æ—¶æ—¶é—´ï¼ˆæ¯100å­—ç¬¦çº¦éœ€1ç§’ï¼‰
            timeout = max(30, len(text) // 50)
            logger.info(f"TTSè¯·æ±‚è¶…æ—¶è®¾ç½®: {timeout}ç§’")

            response = requests.post(url, json=payload, timeout=timeout)

            if response.status_code == 200:
                # ä¿å­˜PCMéŸ³é¢‘
                with tempfile.NamedTemporaryFile(suffix='.pcm', delete=False) as f:
                    f.write(response.content)
                    pcm_path = f.name

                # è½¬æ¢PCMä¸ºWAV
                wav_path = pcm_path.replace('.pcm', '.wav')
                subprocess.run([
                    'ffmpeg', '-y', '-f', 's16le', '-ar', '22050', '-ac', '1',
                    '-i', pcm_path, wav_path
                ], check=True, capture_output=True)

                os.unlink(pcm_path)
                return wav_path
            else:
                logger.error(f"TTSåˆæˆå¤±è´¥: {response.text}")
                return None

        except Exception as e:
            logger.error(f"TTSæœåŠ¡è°ƒç”¨å¤±è´¥: {e}")
            return None

    def chat_stream(self, message):
        """ä¸LLMæµå¼å¯¹è¯"""
        try:
            port = get_config('services.llm', 5002)
            url = f"http://localhost:{port}/chat/stream"

            payload = {
                "message": message,
                "history": self.conversation_history
            }

            response = requests.post(url, json=payload, stream=True, timeout=60)

            if response.status_code == 200:
                full_reply = ""
                # æµå¼è¯»å–å“åº”
                for line in response.iter_lines():
                    if line:
                        line_str = line.decode('utf-8')
                        # è§£æJSONæ ¼å¼çš„æµå¼æ•°æ®
                        try:
                            import json
                            data = json.loads(line_str)

                            # æ£€æŸ¥æ˜¯å¦å®Œæˆ
                            if data.get('done'):
                                break

                            # æå–deltaå†…å®¹
                            chunk = data.get('delta', '')
                            if chunk:
                                full_reply += chunk
                                yield chunk

                        except json.JSONDecodeError:
                            # å¦‚æœä¸æ˜¯JSONï¼Œå°è¯•æ—§çš„data:æ ¼å¼
                            if line_str.startswith('data: '):
                                chunk = line_str[6:]  # ç§»é™¤ "data: " å‰ç¼€
                                if chunk == '[DONE]':
                                    break
                                full_reply += chunk
                                yield chunk

                # æ›´æ–°å¯¹è¯å†å²
                self.conversation_history.append({
                    "role": "user",
                    "content": message
                })
                self.conversation_history.append({
                    "role": "assistant",
                    "content": full_reply
                })

                return full_reply
            else:
                error_msg = "æŠ±æ­‰ï¼Œæˆ‘é‡åˆ°äº†ä¸€äº›é—®é¢˜ï¼Œè¯·ç¨åå†è¯•ã€‚"
                logger.error(f"LLMæµå¼å¯¹è¯å¤±è´¥: {response.text}")
                yield error_msg
                return error_msg

        except Exception as e:
            error_msg = "æŠ±æ­‰ï¼Œæˆ‘é‡åˆ°äº†ä¸€äº›é—®é¢˜ï¼Œè¯·ç¨åå†è¯•ã€‚"
            logger.error(f"LLMæœåŠ¡è°ƒç”¨å¤±è´¥: {e}")
            yield error_msg
            return error_msg

    def clear_history(self):
        """æ¸…ç©ºå¯¹è¯å†å²"""
        self.conversation_history = []
        logger.info("å¯¹è¯å†å²å·²æ¸…ç©º")

    def process_text_input(self, user_text, history):
        """å¤„ç†æ–‡å­—è¾“å…¥ï¼ˆæµå¼è¾“å‡ºï¼‰"""
        if not user_text or not user_text.strip():
            return history, "", None

        # æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°æ˜¾ç¤ºå†å²
        history = history or []
        history.append([user_text, ""])

        # æµå¼è°ƒç”¨LLMè·å–å›å¤
        full_reply = ""
        for chunk in self.chat_stream(user_text):
            full_reply += chunk
            # æ›´æ–°æ˜¾ç¤ºå†å²ï¼ˆæµå¼æ˜¾ç¤ºï¼‰
            history[-1][1] = full_reply
            yield history, "", None

        # ç”Ÿæˆè¯­éŸ³ï¼ˆç­‰å¾…å®Œæ•´æ–‡æœ¬ï¼‰
        logger.info(f"å¼€å§‹ç”Ÿæˆè¯­éŸ³ï¼Œæ–‡æœ¬é•¿åº¦: {len(full_reply)} å­—ç¬¦")
        audio_path = self.text_to_speech(full_reply)

        # è¿”å›æœ€ç»ˆç»“æœï¼ˆåŒ…å«éŸ³é¢‘ï¼‰
        yield history, "", audio_path

    def process_voice_input(self, audio, history):
        """å¤„ç†è¯­éŸ³è¾“å…¥ï¼ˆæµå¼è¾“å‡ºï¼‰"""
        if audio is None:
            yield history, "âš ï¸ è¯·å…ˆå½•åˆ¶è¯­éŸ³", None
            return

        try:
            # ä¿å­˜éŸ³é¢‘ä¸ºä¸´æ—¶æ–‡ä»¶
            with tempfile.NamedTemporaryFile(suffix='.wav', delete=False) as f:
                sample_rate, audio_data = audio
                sf.write(f.name, audio_data, sample_rate)
                temp_path = f.name

            # è¯­éŸ³è¯†åˆ«
            user_text = self.speech_to_text(temp_path)
            os.unlink(temp_path)

            if not user_text:
                yield history, "âŒ è¯­éŸ³è¯†åˆ«å¤±è´¥ï¼Œè¯·é‡è¯•", None
                return

            logger.info(f"è¯­éŸ³è¯†åˆ«ç»“æœ: {user_text}")

            # æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°æ˜¾ç¤ºå†å²
            history = history or []
            history.append([user_text, ""])

            # æµå¼è°ƒç”¨LLMè·å–å›å¤
            full_reply = ""
            for chunk in self.chat_stream(user_text):
                full_reply += chunk
                # æ›´æ–°æ˜¾ç¤ºå†å²ï¼ˆæµå¼æ˜¾ç¤ºï¼‰
                history[-1][1] = full_reply
                yield history, "âœ… è¯†åˆ«æˆåŠŸï¼ŒAIå›å¤ä¸­...", None

            # ç”Ÿæˆè¯­éŸ³ï¼ˆç­‰å¾…å®Œæ•´æ–‡æœ¬ï¼‰
            logger.info(f"å¼€å§‹ç”Ÿæˆè¯­éŸ³ï¼Œæ–‡æœ¬é•¿åº¦: {len(full_reply)} å­—ç¬¦")
            audio_path = self.text_to_speech(full_reply)

            # è¿”å›æœ€ç»ˆç»“æœï¼ˆåŒ…å«éŸ³é¢‘ï¼‰
            yield history, "âœ… è¯†åˆ«å¹¶å›å¤æˆåŠŸ", audio_path

        except Exception as e:
            logger.error(f"å¤„ç†è¯­éŸ³è¾“å…¥å¤±è´¥: {e}")
            yield history, f"âŒ å¤„ç†å¤±è´¥: {str(e)}", None


# åˆ›å»ºå…¨å±€åŠ©æ‰‹å®ä¾‹
assistant = AIAssistant()


# ==================== é…ç½®ç®¡ç†åŠŸèƒ½ ====================
def get_current_config():
    """è·å–å½“å‰é…ç½®"""
    return {
        # ASRé…ç½®
        "asr_model_type": get_config('asr.model_type', 'EN'),

        # LLMé…ç½®
        "llm_mode": get_config('llm.mode', 'api'),
        "llm_api_provider": get_config('llm.api.provider', 'deepseek'),
        "llm_api_key": get_config('llm.api.api_key', ''),
        "llm_api_url": get_config('llm.api.api_url', ''),
        "llm_model": get_config('llm.api.model', 'deepseek-chat'),
        "llm_max_tokens": get_config('llm.api.max_tokens', 512),
        "llm_temperature": get_config('llm.api.temperature', 1.0),
        "llm_system_prompt": get_config('llm.api.system_prompt', ''),

        # LLMæœ¬åœ°æ¨¡å‹é…ç½®
        "llm_local_model_name": get_config('llm.local.model_name', 'qwen'),
        "llm_local_qwen_path": get_config('llm.local.qwen_model_path', '/home/HwHiAiUser/.mindnlp/model/Qwen/Qwen1.5-0.5B-Chat'),
        "llm_local_tinyllama_path": get_config('llm.local.tinyllama_model_path', 'TinyLlama/TinyLlama-1.1B-Chat-v1.0'),
        "llm_local_max_tokens": get_config('llm.local.max_tokens', 128),
        "llm_local_temperature": get_config('llm.local.temperature', 1.0),
        "llm_local_system_prompt": get_config('llm.local.system_prompt', 'You are a helpful and friendly chatbot'),

        # TTSé…ç½®
        "tts_mode": get_config('tts.mode', 'api'),
        "tts_api_provider": get_config('tts.api.provider', 'cosyvoice'),
        "tts_api_key": get_config('tts.api.api_key', ''),
        "tts_model": get_config('tts.api.model', 'cosyvoice-v2'),
        "tts_voice": get_config('tts.api.voice', 'longxiaochun_v2'),

        # æœåŠ¡ç«¯å£
        "port_orchestrator": get_config('services.orchestrator', 5000),
        "port_asr": get_config('services.asr', 5001),
        "port_llm": get_config('services.llm', 5002),
        "port_tts": get_config('services.tts', 5003),
    }


def save_asr_config(model_type):
    """ä¿å­˜ASRé…ç½®"""
    try:
        set_config('asr.model_type', model_type, save=True)
        return "âœ… ASRé…ç½®å·²ä¿å­˜"
    except Exception as e:
        return f"âŒ ä¿å­˜å¤±è´¥: {str(e)}"


def save_llm_config(mode, provider, api_key, api_url, model, max_tokens, temperature, system_prompt,
                   local_model_name, local_qwen_path, local_tinyllama_path,
                   local_max_tokens, local_temperature, local_system_prompt):
    """ä¿å­˜LLMé…ç½®"""
    try:
        set_config('llm.mode', mode, save=False)

        # APIé…ç½®
        set_config('llm.api.provider', provider, save=False)
        set_config('llm.api.api_key', api_key, save=False)
        set_config('llm.api.api_url', api_url, save=False)
        set_config('llm.api.model', model, save=False)
        set_config('llm.api.max_tokens', int(max_tokens), save=False)
        set_config('llm.api.temperature', float(temperature), save=False)
        set_config('llm.api.system_prompt', system_prompt, save=False)

        # æœ¬åœ°æ¨¡å‹é…ç½®
        set_config('llm.local.model_name', local_model_name, save=False)
        set_config('llm.local.qwen_model_path', local_qwen_path, save=False)
        set_config('llm.local.tinyllama_model_path', local_tinyllama_path, save=False)
        set_config('llm.local.max_tokens', int(local_max_tokens), save=False)
        set_config('llm.local.temperature', float(local_temperature), save=False)
        set_config('llm.local.system_prompt', local_system_prompt, save=True)

        return "âœ… LLMé…ç½®å·²ä¿å­˜\n\nâš ï¸ å¦‚æœåˆ‡æ¢äº†æ¨¡å¼æˆ–æœ¬åœ°æ¨¡å‹,è¯·ç‚¹å‡»ä¸‹æ–¹'é‡æ–°åŠ è½½LLMæœåŠ¡'æŒ‰é’®ä½¿é…ç½®ç”Ÿæ•ˆ"
    except Exception as e:
        return f"âŒ ä¿å­˜å¤±è´¥: {str(e)}"


def save_tts_config(mode, provider, api_key, model, voice):
    """ä¿å­˜TTSé…ç½®"""
    try:
        set_config('tts.mode', mode, save=False)
        set_config('tts.api.provider', provider, save=False)
        set_config('tts.api.api_key', api_key, save=False)
        set_config('tts.api.model', model, save=False)
        set_config('tts.api.voice', voice, save=True)
        return "âœ… TTSé…ç½®å·²ä¿å­˜"
    except Exception as e:
        return f"âŒ ä¿å­˜å¤±è´¥: {str(e)}"


def reload_all_services():
    """é‡æ–°åŠ è½½æ‰€æœ‰æœåŠ¡é…ç½®"""
    try:
        reload_config()
        ports = get_config('services')

        # å°è¯•é‡æ–°åŠ è½½å„æœåŠ¡é…ç½®
        results = []
        services = {
            'ASR': f"http://localhost:{ports['asr']}/reload_config",
            'LLM': f"http://localhost:{ports['llm']}/reload_config",
            'TTS': f"http://localhost:{ports['tts']}/reload_config"
        }

        for name, url in services.items():
            try:
                response = requests.post(url, timeout=5)
                if response.status_code == 200:
                    results.append(f"âœ… {name}æœåŠ¡é…ç½®å·²é‡æ–°åŠ è½½")
                else:
                    results.append(f"âš ï¸ {name}æœåŠ¡é‡æ–°åŠ è½½å¤±è´¥")
            except Exception as e:
                results.append(f"âŒ {name}æœåŠ¡ä¸å¯è¾¾: {str(e)}")

        return "\n".join(results)
    except Exception as e:
        return f"âŒ é‡æ–°åŠ è½½å¤±è´¥: {str(e)}"


def reload_llm_service():
    """å•ç‹¬é‡æ–°åŠ è½½LLMæœåŠ¡(ç”¨äºæ¨¡å‹åˆ‡æ¢)"""
    try:
        reload_config()
        port = get_config('services.llm', 5002)
        url = f"http://localhost:{port}/reload_config"

        response = requests.post(url, timeout=30)  # æœ¬åœ°æ¨¡å‹åŠ è½½éœ€è¦æ›´é•¿æ—¶é—´

        if response.status_code == 200:
            result = response.json()
            mode = get_config('llm.mode')
            if mode == 'local':
                model_name = get_config('llm.local.model_name')
                return f"âœ… LLMæœåŠ¡å·²é‡æ–°åŠ è½½\n\næ¨¡å¼: æœ¬åœ°æ¨¡å‹\næ¨¡å‹: {model_name}\n\nâš ï¸ æœ¬åœ°æ¨¡å‹åŠ è½½éœ€è¦30-60ç§’,è¯·è€å¿ƒç­‰å¾…..."
            else:
                return f"âœ… LLMæœåŠ¡å·²é‡æ–°åŠ è½½\n\næ¨¡å¼: API\næ¨¡å‹: {get_config('llm.api.model')}"
        else:
            return f"âŒ LLMæœåŠ¡é‡æ–°åŠ è½½å¤±è´¥: HTTP {response.status_code}"

    except requests.exceptions.Timeout:
        return "âš ï¸ è¯·æ±‚è¶…æ—¶\n\næœ¬åœ°æ¨¡å‹åŠ è½½æ—¶é—´è¾ƒé•¿,è¯·ç¨ååœ¨'æœåŠ¡çŠ¶æ€'é¡µé¢æ£€æŸ¥LLMæœåŠ¡çŠ¶æ€"
    except Exception as e:
        return f"âŒ é‡æ–°åŠ è½½å¤±è´¥: {str(e)}"


# ==================== æœåŠ¡æµ‹è¯•åŠŸèƒ½ ====================
def test_asr_service(audio):
    """æµ‹è¯•ASRæœåŠ¡"""
    if audio is None:
        return "âš ï¸ è¯·å…ˆå½•åˆ¶æˆ–ä¸Šä¼ éŸ³é¢‘"

    try:
        port = get_config('services.asr', 5001)
        url = f"http://localhost:{port}/transcribe"

        # ä¿å­˜éŸ³é¢‘ä¸ºä¸´æ—¶æ–‡ä»¶
        import tempfile
        with tempfile.NamedTemporaryFile(suffix='.wav', delete=False) as f:
            # audioæ˜¯(sample_rate, audio_data)å…ƒç»„
            sample_rate, audio_data = audio
            sf.write(f.name, audio_data, sample_rate)
            temp_path = f.name

        # å‘é€è¯·æ±‚
        with open(temp_path, 'rb') as f:
            files = {'audio': f}
            response = requests.post(url, files=files, timeout=30)

        import os
        os.unlink(temp_path)

        if response.status_code == 200:
            result = response.json()
            return f"âœ… è¯†åˆ«æˆåŠŸ!\n\nè¯†åˆ«ç»“æœ: {result.get('text', '')}"
        else:
            return f"âŒ è¯†åˆ«å¤±è´¥: {response.text}"

    except Exception as e:
        return f"âŒ æµ‹è¯•å¤±è´¥: {str(e)}"


def test_llm_service(text):
    """æµ‹è¯•LLMæœåŠ¡"""
    if not text:
        return "âš ï¸ è¯·è¾“å…¥æµ‹è¯•æ–‡æœ¬"

    try:
        port = get_config('services.llm', 5002)
        url = f"http://localhost:{port}/chat"

        payload = {
            "message": text,
            "history": []
        }

        response = requests.post(url, json=payload, timeout=60)

        if response.status_code == 200:
            result = response.json()
            return f"âœ… å¯¹è¯æˆåŠŸ!\n\nå›å¤: {result.get('message', '')}"
        else:
            return f"âŒ å¯¹è¯å¤±è´¥: {response.text}"

    except Exception as e:
        return f"âŒ æµ‹è¯•å¤±è´¥: {str(e)}"


def test_tts_service(text):
    """æµ‹è¯•TTSæœåŠ¡"""
    if not text:
        return "âš ï¸ è¯·è¾“å…¥æµ‹è¯•æ–‡æœ¬", None

    try:
        port = get_config('services.tts', 5003)
        url = f"http://localhost:{port}/synthesize"

        payload = {"text": text}
        response = requests.post(url, json=payload, timeout=30)

        if response.status_code == 200:
            # ä¿å­˜éŸ³é¢‘
            import tempfile
            with tempfile.NamedTemporaryFile(suffix='.pcm', delete=False) as f:
                f.write(response.content)
                audio_path = f.name

            # è½¬æ¢PCMä¸ºWAV
            import subprocess
            wav_path = audio_path.replace('.pcm', '.wav')
            subprocess.run([
                'ffmpeg', '-y', '-f', 's16le', '-ar', '22050', '-ac', '1',
                '-i', audio_path, wav_path
            ], check=True, capture_output=True)

            import os
            os.unlink(audio_path)

            return f"âœ… åˆæˆæˆåŠŸ!", wav_path
        else:
            return f"âŒ åˆæˆå¤±è´¥: {response.text}", None

    except Exception as e:
        return f"âŒ æµ‹è¯•å¤±è´¥: {str(e)}", None


# ==================== éŸ³è‰²å…‹éš†åŠŸèƒ½ ====================
def create_voice_enrollment(target_model, prefix, audio_url):
    """åˆ›å»ºéŸ³è‰²å…‹éš†"""
    if not target_model or not prefix or not audio_url:
        return "âš ï¸ è¯·å¡«å†™æ‰€æœ‰å¿…å¡«é¡¹", ""

    try:
        port = get_config('services.tts', 5003)
        url = f"http://localhost:{port}/voice/create"

        payload = {
            "target_model": target_model,
            "prefix": prefix,
            "url": audio_url
        }

        response = requests.post(url, json=payload, timeout=180)  # éŸ³è‰²åˆ›å»ºéœ€è¦è¾ƒé•¿æ—¶é—´,è®¾ç½®3åˆ†é’Ÿè¶…æ—¶

        if response.status_code == 200:
            result = response.json()
            voice_id = result.get('voice_id', '')
            return f"âœ… éŸ³è‰²åˆ›å»ºæˆåŠŸ!\n\nVoice ID: {voice_id}\n\nè¯·ä½¿ç”¨ä¸‹æ–¹çš„'æŸ¥è¯¢éŸ³è‰²çŠ¶æ€'åŠŸèƒ½æŸ¥çœ‹å®¡æ ¸è¿›åº¦", voice_id
        else:
            return f"âŒ åˆ›å»ºå¤±è´¥: {response.text}", ""

    except Exception as e:
        return f"âŒ åˆ›å»ºå¤±è´¥: {str(e)}", ""


def query_voice_status(voice_id):
    """æŸ¥è¯¢éŸ³è‰²çŠ¶æ€"""
    if not voice_id:
        return "âš ï¸ è¯·è¾“å…¥Voice ID"

    try:
        port = get_config('services.tts', 5003)
        url = f"http://localhost:{port}/voice/query"

        payload = {"voice_id": voice_id}
        response = requests.post(url, json=payload, timeout=10)

        if response.status_code == 200:
            result = response.json()
            voice_info = result.get('voice_info', {})

            status = voice_info.get('status', 'UNKNOWN')
            status_emoji = {
                'OK': 'âœ…',
                'DEPLOYING': 'â³',
                'UNDEPLOYED': 'âŒ'
            }.get(status, 'â“')

            status_text = {
                'OK': 'å®¡æ ¸é€šè¿‡,å¯ä»¥ä½¿ç”¨',
                'DEPLOYING': 'å®¡æ ¸ä¸­,è¯·ç¨å€™',
                'UNDEPLOYED': 'å®¡æ ¸æœªé€šè¿‡,æ— æ³•ä½¿ç”¨'
            }.get(status, 'æœªçŸ¥çŠ¶æ€')

            info = f"{status_emoji} éŸ³è‰²çŠ¶æ€: {status_text}\n\n"
            info += f"Voice ID: {voice_id}\n"
            info += f"åˆ›å»ºæ—¶é—´: {voice_info.get('gmt_create', 'N/A')}\n"
            info += f"ä¿®æ”¹æ—¶é—´: {voice_info.get('gmt_modified', 'N/A')}\n"
            info += f"ç›®æ ‡æ¨¡å‹: {voice_info.get('target_model', 'N/A')}\n"
            info += f"éŸ³é¢‘é“¾æ¥: {voice_info.get('resource_link', 'N/A')}\n"

            if status == 'OK':
                info += "\nâœ… è¯¥éŸ³è‰²å·²å¯ç”¨,å¯ä»¥åœ¨TTSé…ç½®ä¸­ä½¿ç”¨è¯¥Voice IDä½œä¸ºå‘éŸ³äºº"

            return info
        else:
            return f"âŒ æŸ¥è¯¢å¤±è´¥: {response.text}"

    except Exception as e:
        return f"âŒ æŸ¥è¯¢å¤±è´¥: {str(e)}"


def list_all_voices(prefix, page_index, page_size):
    """åˆ—å‡ºæ‰€æœ‰éŸ³è‰²"""
    try:
        port = get_config('services.tts', 5003)
        url = f"http://localhost:{port}/voice/list"

        payload = {
            "prefix": prefix if prefix else None,
            "page_index": int(page_index),
            "page_size": int(page_size)
        }

        response = requests.post(url, json=payload, timeout=10)

        if response.status_code == 200:
            result = response.json()
            voices = result.get('voices', [])
            count = result.get('count', 0)

            if count == 0:
                return "ğŸ“‹ æœªæ‰¾åˆ°ä»»ä½•éŸ³è‰²"

            info = f"ğŸ“‹ æ‰¾åˆ° {count} ä¸ªéŸ³è‰²:\n\n"
            for i, voice in enumerate(voices, 1):
                status = voice.get('status', 'UNKNOWN')
                status_emoji = {
                    'OK': 'âœ…',
                    'DEPLOYING': 'â³',
                    'UNDEPLOYED': 'âŒ'
                }.get(status, 'â“')

                info += f"{i}. {status_emoji} {voice.get('voice_id', 'N/A')}\n"
                info += f"   çŠ¶æ€: {status}\n"
                info += f"   åˆ›å»ºæ—¶é—´: {voice.get('gmt_create', 'N/A')}\n\n"

            return info
        else:
            return f"âŒ æŸ¥è¯¢å¤±è´¥: {response.text}"

    except Exception as e:
        return f"âŒ æŸ¥è¯¢å¤±è´¥: {str(e)}"


def update_voice_enrollment(voice_id, new_audio_url):
    """æ›´æ–°éŸ³è‰²"""
    if not voice_id or not new_audio_url:
        return "âš ï¸ è¯·å¡«å†™Voice IDå’Œæ–°éŸ³é¢‘URL"

    try:
        port = get_config('services.tts', 5003)
        url = f"http://localhost:{port}/voice/update"

        payload = {
            "voice_id": voice_id,
            "url": new_audio_url
        }

        response = requests.post(url, json=payload, timeout=30)

        if response.status_code == 200:
            return "âœ… éŸ³è‰²æ›´æ–°æˆåŠŸ!\n\nè¯·ç­‰å¾…å®¡æ ¸å®Œæˆ,ä½¿ç”¨'æŸ¥è¯¢éŸ³è‰²çŠ¶æ€'æŸ¥çœ‹è¿›åº¦"
        else:
            return f"âŒ æ›´æ–°å¤±è´¥: {response.text}"

    except Exception as e:
        return f"âŒ æ›´æ–°å¤±è´¥: {str(e)}"


def delete_voice_enrollment(voice_id):
    """åˆ é™¤éŸ³è‰²"""
    if not voice_id:
        return "âš ï¸ è¯·è¾“å…¥Voice ID"

    try:
        port = get_config('services.tts', 5003)
        url = f"http://localhost:{port}/voice/delete"

        payload = {"voice_id": voice_id}
        response = requests.post(url, json=payload, timeout=10)

        if response.status_code == 200:
            return "âœ… éŸ³è‰²åˆ é™¤æˆåŠŸ!"
        else:
            return f"âŒ åˆ é™¤å¤±è´¥: {response.text}"

    except Exception as e:
        return f"âŒ åˆ é™¤å¤±è´¥: {str(e)}"


def check_services_health():
    """æ£€æŸ¥æ‰€æœ‰æœåŠ¡å¥åº·çŠ¶æ€"""
    try:
        port = get_config('services.orchestrator', 5000)
        url = f"http://localhost:{port}/health"

        response = requests.get(url, timeout=5)

        if response.status_code == 200:
            result = response.json()
            services = result.get('services', {})

            status_text = "ğŸ” æœåŠ¡å¥åº·çŠ¶æ€:\n\n"
            for name, status in services.items():
                emoji = "âœ…" if status == "healthy" else "âŒ"
                status_text += f"{emoji} {name.upper()}: {status}\n"

            return status_text
        else:
            return "âŒ æ— æ³•è·å–å¥åº·çŠ¶æ€"

    except Exception as e:
        return f"âŒ æ£€æŸ¥å¤±è´¥: {str(e)}\n\nè¯·ç¡®ä¿æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨"


# ==================== Gradio ç•Œé¢ ====================
def create_ui():
    """åˆ›å»ºGradioç•Œé¢"""

    current_config = get_current_config()

    with gr.Blocks(title="AIè¯­éŸ³åŠ©æ‰‹ä¸­å¿ƒ", theme=gr.themes.Soft()) as demo:
        gr.Markdown("# ğŸ¤– AIè¯­éŸ³åŠ©æ‰‹ä¸­å¿ƒ")
        gr.Markdown("AIå¯¹è¯ + æœåŠ¡é…ç½®ç®¡ç† ä¸€ä½“åŒ–ç•Œé¢")

        with gr.Tabs():
            # ==================== AIå¯¹è¯æ ‡ç­¾é¡µ ====================
            with gr.Tab("ğŸ’¬ AIå¯¹è¯"):
                gr.Markdown("### ä¸AIæ™ºèƒ½å¯¹è¯")
                gr.Markdown("æ”¯æŒæ–‡å­—å’Œè¯­éŸ³è¾“å…¥ï¼ŒAIå›å¤ä¼šåŒæ—¶æ˜¾ç¤ºæ–‡å­—å’Œè¯­éŸ³")

                with gr.Row():
                    with gr.Column(scale=2):
                        # å¯¹è¯å†å²æ˜¾ç¤º
                        chatbot = gr.Chatbot(
                            label="å¯¹è¯è®°å½•",
                            height=450,
                            show_label=True,
                            bubble_full_width=False
                        )

                        # æ–‡å­—è¾“å…¥åŒºåŸŸ
                        with gr.Row():
                            text_input = gr.Textbox(
                                label="",
                                placeholder="è¾“å…¥æ¶ˆæ¯...",
                                lines=2,
                                scale=4
                            )
                            text_submit_btn = gr.Button("ğŸ“¤ å‘é€", variant="primary", scale=1)

                        # è¯­éŸ³è¾“å…¥åŒºåŸŸ
                        gr.Markdown("#### ğŸ¤ è¯­éŸ³è¾“å…¥")
                        with gr.Row():
                            audio_input = gr.Audio(
                                label="å½•åˆ¶æˆ–ä¸Šä¼ éŸ³é¢‘",
                                type="numpy",
                                scale=3
                            )
                            voice_submit_btn = gr.Button("ğŸ™ï¸ è¯­éŸ³å‘é€", variant="secondary", scale=1)

                        voice_status = gr.Textbox(label="", lines=1, show_label=False)

                    with gr.Column(scale=1):
                        # AIå›å¤è¯­éŸ³æ’­æ”¾åŒºåŸŸ
                        gr.Markdown("### ğŸ”Š AIè¯­éŸ³å›å¤")
                        audio_output = gr.Audio(
                            label="ç‚¹å‡»æ’­æ”¾",
                            type="filepath",
                            autoplay=True
                        )

                        gr.Markdown("---")

                        # æ§åˆ¶æŒ‰é’®
                        clear_chat_btn = gr.Button("ğŸ—‘ï¸ æ¸…ç©ºå¯¹è¯", variant="stop")

                        gr.Markdown("### ğŸ’¡ ä½¿ç”¨æç¤º")
                        gr.Markdown("""
                        **æ–‡å­—è¾“å…¥ï¼š**
                        - åœ¨è¾“å…¥æ¡†è¾“å…¥æ¶ˆæ¯
                        - ç‚¹å‡»"å‘é€"æˆ–æŒ‰Enter

                        **è¯­éŸ³è¾“å…¥ï¼š**
                        - ç‚¹å‡»éº¦å…‹é£å›¾æ ‡å½•éŸ³
                        - æˆ–ä¸Šä¼ éŸ³é¢‘æ–‡ä»¶
                        - ç‚¹å‡»"è¯­éŸ³å‘é€"

                        **è¯­éŸ³æ’­æ”¾ï¼š**
                        - AIå›å¤åè‡ªåŠ¨æ’­æ”¾
                        - å¯é‡å¤ç‚¹å‡»æ’­æ”¾
                        """)

                # äº‹ä»¶ç»‘å®š
                # æ–‡å­—è¾“å…¥
                text_submit_btn.click(
                    assistant.process_text_input,
                    inputs=[text_input, chatbot],
                    outputs=[chatbot, text_input, audio_output]
                )

                text_input.submit(
                    assistant.process_text_input,
                    inputs=[text_input, chatbot],
                    outputs=[chatbot, text_input, audio_output]
                )

                # è¯­éŸ³è¾“å…¥
                voice_submit_btn.click(
                    assistant.process_voice_input,
                    inputs=[audio_input, chatbot],
                    outputs=[chatbot, voice_status, audio_output]
                )

                # æ¸…ç©ºå¯¹è¯
                def clear_conversation():
                    assistant.clear_history()
                    return [], "", None, ""

                clear_chat_btn.click(
                    clear_conversation,
                    outputs=[chatbot, text_input, audio_output, voice_status]
                )

            # ==================== æœåŠ¡çŠ¶æ€æ ‡ç­¾é¡µ ====================
            with gr.Tab("ğŸ“Š æœåŠ¡çŠ¶æ€"):
                gr.Markdown("### æ£€æŸ¥æ‰€æœ‰æœåŠ¡çš„è¿è¡ŒçŠ¶æ€")

                health_output = gr.Textbox(label="å¥åº·çŠ¶æ€", lines=8)
                check_btn = gr.Button("ğŸ”„ æ£€æŸ¥æœåŠ¡çŠ¶æ€", variant="primary")
                check_btn.click(check_services_health, outputs=health_output)

                gr.Markdown("### é‡æ–°åŠ è½½é…ç½®")
                reload_output = gr.Textbox(label="é‡æ–°åŠ è½½ç»“æœ", lines=5)
                reload_btn = gr.Button("ğŸ”„ é‡æ–°åŠ è½½æ‰€æœ‰æœåŠ¡é…ç½®")
                reload_btn.click(reload_all_services, outputs=reload_output)

            # ==================== ASRé…ç½®æ ‡ç­¾é¡µ ====================
            with gr.Tab("ğŸ¤ ASRé…ç½®"):
                gr.Markdown("### è¯­éŸ³è¯†åˆ«æœåŠ¡é…ç½®")

                asr_model_type = gr.Radio(
                    choices=["CN", "EN"],
                    value=current_config["asr_model_type"],
                    label="æ¨¡å‹ç±»å‹"
                )

                asr_save_btn = gr.Button("ğŸ’¾ ä¿å­˜ASRé…ç½®", variant="primary")
                asr_status = gr.Textbox(label="çŠ¶æ€")
                asr_save_btn.click(save_asr_config, inputs=asr_model_type, outputs=asr_status)

                gr.Markdown("### æµ‹è¯•ASRæœåŠ¡")
                asr_audio_input = gr.Audio(label="å½•åˆ¶æˆ–ä¸Šä¼ éŸ³é¢‘", type="numpy")
                asr_test_btn = gr.Button("ğŸ§ª æµ‹è¯•è¯†åˆ«")
                asr_test_output = gr.Textbox(label="æµ‹è¯•ç»“æœ", lines=5)
                asr_test_btn.click(test_asr_service, inputs=asr_audio_input, outputs=asr_test_output)

            # ==================== LLMé…ç½®æ ‡ç­¾é¡µ ====================
            with gr.Tab("ğŸ§  LLMé…ç½®"):
                gr.Markdown("### å¤§æ¨¡å‹æœåŠ¡é…ç½®")

                llm_mode = gr.Radio(
                    choices=["api", "local"],
                    value=current_config["llm_mode"],
                    label="è¿è¡Œæ¨¡å¼"
                )

                with gr.Group():
                    gr.Markdown("#### APIé…ç½® (åœ¨çº¿æ¨¡å¼)")
                    llm_provider = gr.Textbox(
                        value=current_config["llm_api_provider"],
                        label="APIæä¾›å•†"
                    )
                    llm_api_key = gr.Textbox(
                        value=current_config["llm_api_key"],
                        label="API Key",
                        type="password"
                    )
                    llm_api_url = gr.Textbox(
                        value=current_config["llm_api_url"],
                        label="API URL"
                    )
                    llm_model = gr.Textbox(
                        value=current_config["llm_model"],
                        label="æ¨¡å‹åç§°"
                    )
                    llm_max_tokens = gr.Slider(
                        minimum=64,
                        maximum=2048,
                        value=current_config["llm_max_tokens"],
                        label="æœ€å¤§Tokenæ•°"
                    )
                    llm_temperature = gr.Slider(
                        minimum=0.0,
                        maximum=2.0,
                        value=current_config["llm_temperature"],
                        label="Temperature"
                    )
                    llm_system_prompt = gr.Textbox(
                        value=current_config["llm_system_prompt"],
                        label="ç³»ç»Ÿæç¤ºè¯",
                        lines=3
                    )

                with gr.Group():
                    gr.Markdown("#### æœ¬åœ°æ¨¡å‹é…ç½® (ç¦»çº¿æ¨¡å¼)")
                    gr.Markdown("âš ï¸ æœ¬åœ°æ¨¡å‹éœ€è¦è¾ƒé•¿åŠ è½½æ—¶é—´(30-60ç§’)")

                    llm_local_model_name = gr.Radio(
                        choices=["qwen", "tinyllama"],
                        value=current_config["llm_local_model_name"],
                        label="æœ¬åœ°æ¨¡å‹é€‰æ‹©"
                    )

                    llm_local_qwen_path = gr.Textbox(
                        value=current_config["llm_local_qwen_path"],
                        label="Qwenæ¨¡å‹è·¯å¾„",
                        placeholder="/home/HwHiAiUser/.mindnlp/model/Qwen/Qwen1.5-0.5B-Chat"
                    )

                    llm_local_tinyllama_path = gr.Textbox(
                        value=current_config["llm_local_tinyllama_path"],
                        label="TinyLlamaæ¨¡å‹è·¯å¾„",
                        placeholder="TinyLlama/TinyLlama-1.1B-Chat-v1.0"
                    )

                    llm_local_max_tokens = gr.Slider(
                        minimum=32,
                        maximum=512,
                        value=current_config["llm_local_max_tokens"],
                        label="æœ€å¤§Tokenæ•°"
                    )

                    llm_local_temperature = gr.Slider(
                        minimum=0.0,
                        maximum=2.0,
                        value=current_config["llm_local_temperature"],
                        label="Temperature"
                    )

                    llm_local_system_prompt = gr.Textbox(
                        value=current_config["llm_local_system_prompt"],
                        label="ç³»ç»Ÿæç¤ºè¯",
                        lines=3
                    )

                llm_save_btn = gr.Button("ğŸ’¾ ä¿å­˜LLMé…ç½®", variant="primary")
                llm_status = gr.Textbox(label="çŠ¶æ€", lines=3)
                llm_save_btn.click(
                    save_llm_config,
                    inputs=[llm_mode, llm_provider, llm_api_key, llm_api_url,
                           llm_model, llm_max_tokens, llm_temperature, llm_system_prompt,
                           llm_local_model_name, llm_local_qwen_path, llm_local_tinyllama_path,
                           llm_local_max_tokens, llm_local_temperature, llm_local_system_prompt],
                    outputs=llm_status
                )

                gr.Markdown("### é‡æ–°åŠ è½½LLMæœåŠ¡")
                gr.Markdown("âš ï¸ åˆ‡æ¢æ¨¡å¼æˆ–æœ¬åœ°æ¨¡å‹å,å¿…é¡»é‡æ–°åŠ è½½æœåŠ¡æ‰èƒ½ç”Ÿæ•ˆ")
                llm_reload_btn = gr.Button("ğŸ”„ é‡æ–°åŠ è½½LLMæœåŠ¡", variant="secondary")
                llm_reload_output = gr.Textbox(label="é‡æ–°åŠ è½½ç»“æœ", lines=4)
                llm_reload_btn.click(reload_llm_service, outputs=llm_reload_output)

                gr.Markdown("### æµ‹è¯•LLMæœåŠ¡")
                llm_test_input = gr.Textbox(label="æµ‹è¯•è¾“å…¥", placeholder="è¾“å…¥æµ‹è¯•é—®é¢˜...")
                llm_test_btn = gr.Button("ğŸ§ª æµ‹è¯•å¯¹è¯")
                llm_test_output = gr.Textbox(label="æµ‹è¯•ç»“æœ", lines=5)
                llm_test_btn.click(test_llm_service, inputs=llm_test_input, outputs=llm_test_output)

            # ==================== TTSé…ç½®æ ‡ç­¾é¡µ ====================
            with gr.Tab("ğŸ”Š TTSé…ç½®"):
                gr.Markdown("### è¯­éŸ³åˆæˆæœåŠ¡é…ç½®")

                tts_mode = gr.Radio(
                    choices=["api", "local"],
                    value=current_config["tts_mode"],
                    label="è¿è¡Œæ¨¡å¼"
                )

                with gr.Group():
                    gr.Markdown("#### APIé…ç½®")
                    tts_provider = gr.Textbox(
                        value=current_config["tts_api_provider"],
                        label="APIæä¾›å•†"
                    )
                    tts_api_key = gr.Textbox(
                        value=current_config["tts_api_key"],
                        label="API Key",
                        type="password"
                    )
                    tts_model = gr.Textbox(
                        value=current_config["tts_model"],
                        label="æ¨¡å‹åç§°"
                    )
                    tts_voice = gr.Textbox(
                        value=current_config["tts_voice"],
                        label="å‘éŸ³äºº"
                    )

                tts_save_btn = gr.Button("ğŸ’¾ ä¿å­˜TTSé…ç½®", variant="primary")
                tts_status = gr.Textbox(label="çŠ¶æ€")
                tts_save_btn.click(
                    save_tts_config,
                    inputs=[tts_mode, tts_provider, tts_api_key, tts_model, tts_voice],
                    outputs=tts_status
                )

                gr.Markdown("### æµ‹è¯•TTSæœåŠ¡")
                tts_test_input = gr.Textbox(label="æµ‹è¯•æ–‡æœ¬", placeholder="è¾“å…¥è¦åˆæˆçš„æ–‡æœ¬...")
                tts_test_btn = gr.Button("ğŸ§ª æµ‹è¯•åˆæˆ")
                tts_test_status = gr.Textbox(label="æµ‹è¯•çŠ¶æ€", lines=2)
                tts_test_audio = gr.Audio(label="åˆæˆéŸ³é¢‘")
                tts_test_btn.click(
                    test_tts_service,
                    inputs=tts_test_input,
                    outputs=[tts_test_status, tts_test_audio]
                )

            # ==================== éŸ³è‰²å…‹éš†æ ‡ç­¾é¡µ ====================
            with gr.Tab("ğŸ¨ éŸ³è‰²å…‹éš†"):
                gr.Markdown("### CosyVoiceéŸ³è‰²å…‹éš†æœåŠ¡")
                gr.Markdown("""
                ä½¿ç”¨10~20ç§’éŸ³é¢‘æ ·æœ¬å³å¯ç”Ÿæˆé«˜åº¦ç›¸ä¼¼ä¸”è‡ªç„¶çš„å®šåˆ¶å£°éŸ³ã€‚

                **éŸ³é¢‘è¦æ±‚:**
                - æ ¼å¼: WAV (16bit), MP3, M4A
                - æ—¶é•¿: 10~20ç§’
                - å¤§å°: â‰¤ 10 MB
                - é‡‡æ ·ç‡: â‰¥ 16 kHz
                - å†…å®¹: è‡³å°‘åŒ…å«ä¸€æ®µ5ç§’ä»¥ä¸Šçš„è¿ç»­ã€æ¸…æ™°ã€æ— èƒŒæ™¯éŸ³çš„æœ—è¯»
                - è¯­è¨€: ä¸­æ–‡ã€è‹±æ–‡
                """)

                with gr.Group():
                    gr.Markdown("#### åˆ›å»ºæ–°éŸ³è‰²")
                    voice_create_model = gr.Dropdown(
                        choices=["cosyvoice-v1", "cosyvoice-v2", "cosyvoice-v3", "cosyvoice-v3-plus"],
                        value="cosyvoice-v2",
                        label="ç›®æ ‡æ¨¡å‹",
                        info="æ¨èä½¿ç”¨v3-plusè·å¾—æœ€ä½³æ•ˆæœ"
                    )
                    voice_create_prefix = gr.Textbox(
                        label="éŸ³è‰²å‰ç¼€",
                        placeholder="myvoice (ä»…å…è®¸å°å†™å­—æ¯å’Œæ•°å­—,å°‘äº10ä¸ªå­—ç¬¦)",
                        max_lines=1
                    )
                    voice_create_url = gr.Textbox(
                        label="éŸ³é¢‘URL",
                        placeholder="https://your-audio-file-url.wav",
                        info="éŸ³é¢‘æ–‡ä»¶å¿…é¡»æ˜¯å…¬ç½‘å¯è®¿é—®çš„URL"
                    )
                    voice_create_btn = gr.Button("ğŸ¨ åˆ›å»ºéŸ³è‰²", variant="primary")
                    voice_create_output = gr.Textbox(label="åˆ›å»ºç»“æœ", lines=5)
                    voice_created_id = gr.Textbox(label="Voice ID", interactive=False)

                    voice_create_btn.click(
                        create_voice_enrollment,
                        inputs=[voice_create_model, voice_create_prefix, voice_create_url],
                        outputs=[voice_create_output, voice_created_id]
                    )

                with gr.Group():
                    gr.Markdown("#### æŸ¥è¯¢éŸ³è‰²çŠ¶æ€")
                    voice_query_id = gr.Textbox(
                        label="Voice ID",
                        placeholder="cosyvoice-v2-myvoice-xxxxxxxx"
                    )
                    voice_query_btn = gr.Button("ğŸ” æŸ¥è¯¢çŠ¶æ€")
                    voice_query_output = gr.Textbox(label="éŸ³è‰²ä¿¡æ¯", lines=10)

                    voice_query_btn.click(
                        query_voice_status,
                        inputs=voice_query_id,
                        outputs=voice_query_output
                    )

                with gr.Group():
                    gr.Markdown("#### åˆ—å‡ºæ‰€æœ‰éŸ³è‰²")
                    with gr.Row():
                        voice_list_prefix = gr.Textbox(
                            label="å‰ç¼€ç­›é€‰ (å¯é€‰)",
                            placeholder="myvoice"
                        )
                        voice_list_page_index = gr.Number(
                            label="é¡µç ",
                            value=0,
                            precision=0
                        )
                        voice_list_page_size = gr.Number(
                            label="æ¯é¡µæ•°é‡",
                            value=10,
                            precision=0
                        )
                    voice_list_btn = gr.Button("ğŸ“‹ åˆ—å‡ºéŸ³è‰²")
                    voice_list_output = gr.Textbox(label="éŸ³è‰²åˆ—è¡¨", lines=15)

                    voice_list_btn.click(
                        list_all_voices,
                        inputs=[voice_list_prefix, voice_list_page_index, voice_list_page_size],
                        outputs=voice_list_output
                    )

                with gr.Group():
                    gr.Markdown("#### æ›´æ–°éŸ³è‰²")
                    voice_update_id = gr.Textbox(
                        label="Voice ID",
                        placeholder="cosyvoice-v2-myvoice-xxxxxxxx"
                    )
                    voice_update_url = gr.Textbox(
                        label="æ–°éŸ³é¢‘URL",
                        placeholder="https://your-new-audio-file-url.wav"
                    )
                    voice_update_btn = gr.Button("ğŸ”„ æ›´æ–°éŸ³è‰²")
                    voice_update_output = gr.Textbox(label="æ›´æ–°ç»“æœ", lines=3)

                    voice_update_btn.click(
                        update_voice_enrollment,
                        inputs=[voice_update_id, voice_update_url],
                        outputs=voice_update_output
                    )

                with gr.Group():
                    gr.Markdown("#### åˆ é™¤éŸ³è‰²")
                    gr.Markdown("âš ï¸ åˆ é™¤æ“ä½œä¸å¯é€†,è¯·è°¨æ…æ“ä½œ")
                    voice_delete_id = gr.Textbox(
                        label="Voice ID",
                        placeholder="cosyvoice-v2-myvoice-xxxxxxxx"
                    )
                    voice_delete_btn = gr.Button("ğŸ—‘ï¸ åˆ é™¤éŸ³è‰²", variant="stop")
                    voice_delete_output = gr.Textbox(label="åˆ é™¤ç»“æœ", lines=2)

                    voice_delete_btn.click(
                        delete_voice_enrollment,
                        inputs=voice_delete_id,
                        outputs=voice_delete_output
                    )

    return demo


if __name__ == "__main__":
    # åˆ›å»ºå¹¶å¯åŠ¨ç•Œé¢
    demo = create_ui()

    port = get_config('services.web_ui', 8080)
    share = get_config('web.share', False)

    logger.info(f"ğŸŒ Webé…ç½®ç•Œé¢å¯åŠ¨åœ¨ç«¯å£: {port}")

    demo.launch(
        server_name="0.0.0.0",
        server_port=port,
        share=share
    )
